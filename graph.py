import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.linear_model import LinearRegression
from sklearn.preprocessing import PolynomialFeatures
from sklearn.metrics import r2_score
import streamlit as st

# Bitcoin data
bitcoin_data = [
    ('2025-02-28', 84705.63, 1), ('2025-02-27', 84076.86, 2), ('2025-02-26', 88638.89, 3),
    ('2025-02-25', 91437.12, 4), ('2025-02-24', 96277.96, 5), ('2025-02-23', 96577.80, 6),
    ('2025-02-22', 96134.20, 7), ('2025-02-21', 98340.67, 8), ('2025-02-20', 96632.68, 9),
    ('2025-02-19', 95532.53, 10), ('2025-02-18', 95773.81, 11), ('2025-02-17', 96179.01, 12),
    ('2025-02-16', 97580.49, 13), ('2025-02-15', 97508.38, 14), ('2025-02-14', 96623.37, 15),
    ('2025-02-13', 97888.75, 16), ('2025-02-12', 95745.70, 17), ('2025-02-11', 97438.13, 18),
    ('2025-02-10', 96499.46, 19), ('2025-02-09', 96481.31, 20), ('2025-02-08', 96533.26, 21),
    ('2025-02-07', 96581.32, 22), ('2025-02-06', 96610.64, 23), ('2025-02-05', 97878.01, 24),
    ('2025-02-04', 101398.72, 25), ('2025-02-03', 97681.10, 26), ('2025-02-02', 100661.54, 27),
    ('2025-02-01', 102402.80, 28), ('2025-01-31', 104737.56, 29), ('2025-01-30', 103709.34, 30),
    ('2025-01-29', 101317.52, 31), ('2025-01-28', 102095.41, 32), ('2025-01-27', 102680.30, 33),
    ('2025-01-26', 104713.21, 34), ('2025-01-25', 104824.03, 35), ('2025-01-24', 103965.67, 36),
    ('2025-01-23', 103657.67, 37), ('2025-01-22', 106136.38, 38), ('2025-01-21', 102052.58, 39),
    ('2025-01-20', 101083.75, 40), ('2025-01-19', 104411.29, 41), ('2025-01-18', 104124.95, 42),
    ('2025-01-17', 100025.77, 43), ('2025-01-16', 100505.30, 44), ('2025-01-15', 96534.05, 45),
    ('2025-01-14', 94519.01, 46), ('2025-01-13', 94488.89, 47), ('2025-01-12', 94565.73, 48),
    ('2025-01-11', 94700.84, 49), ('2025-01-10', 92494.49, 50), ('2025-01-09', 95043.48, 51),
    ('2025-01-08', 96924.16, 52), ('2025-01-07', 102248.85, 53), ('2025-01-06', 98314.95, 54),
    ('2025-01-05', 98233.91, 55), ('2025-01-04', 98106.99, 56), ('2025-01-03', 96881.73, 57),
    ('2025-01-02', 94416.29, 58), ('2025-01-01', 93425.10, 59), ('2024-12-31', 92643.25, 60),
    ('2024-12-30', 93527.20, 61), ('2024-12-29', 95174.05, 62), ('2024-12-28', 94160.19, 63),
    ('2024-12-27', 95704.98, 64), ('2024-12-26', 99297.70, 65), ('2024-12-25', 98675.91, 66),
    ('2024-12-24', 94684.34, 67), ('2024-12-23', 95099.39, 68), ('2024-12-22', 97218.32, 69),
    ('2024-12-21', 97756.20, 70), ('2024-12-20', 97484.70, 71), ('2024-12-19', 100070.69, 72),
    ('2024-12-18', 106147.30, 73), ('2024-12-17', 106030.69, 74), ('2024-12-16', 104293.58, 75),
    ('2024-12-15', 101373.53, 76), ('2024-12-14', 101451.44, 77), ('2024-12-13', 100046.65, 78),
    ('2024-12-12', 101167.80, 79), ('2024-12-11', 96656.06, 80), ('2024-12-10', 97441.23, 81),
    ('2024-12-09', 101237.06, 82), ('2024-12-08', 99921.91, 83), ('2024-12-07', 99916.71, 84),
    ('2024-12-06', 97074.23, 85), ('2024-12-05', 98741.54, 86), ('2024-12-04', 95988.53, 87),
    ('2024-12-03', 95854.59, 88), ('2024-12-02', 97276.01, 89), ('2024-12-01', 96461.34, 90),
    ('2024-11-30', 97468.81, 91), ('2024-11-29', 95653.95, 92), ('2024-11-28', 95954.95, 93),
    ('2024-11-27', 91978.14, 94), ('2024-11-26', 93087.28, 95), ('2024-11-25', 98033.45, 96),
    ('2024-11-24', 97778.09, 97), ('2024-11-23', 99006.74, 98), ('2024-11-22', 98496.43, 99),
    ('2024-11-21', 94334.64, 100), ('2024-11-20', 92341.89, 101), ('2024-11-19', 90536.81, 102),
    ('2024-11-18', 89843.72, 103), ('2024-11-17', 90558.46, 104), ('2024-11-16', 91064.37, 105),
    ('2024-11-15', 87284.18, 106), ('2024-11-14', 90574.88, 107), ('2024-11-13', 87929.97, 108),
    ('2024-11-12', 88705.56, 109), ('2024-11-11', 80471.41, 110), ('2024-11-10', 76775.55, 111),
    ('2024-11-09', 76556.19, 112), ('2024-11-08', 75902.84, 113), ('2024-11-07', 75637.09, 114),
    ('2024-11-06', 69358.50, 115), ('2024-11-05', 67811.17, 116), ('2024-11-04', 68742.13, 117),
    ('2024-11-03', 69296.38, 118), ('2024-11-02', 69486.02, 119), ('2024-11-01', 70216.90, 120),
    ('2024-10-31', 72335.05, 121), ('2024-10-30', 72715.37, 122), ('2024-10-29', 69910.05, 123),
    ('2024-10-28', 67922.67, 124), ('2024-10-27', 67023.48, 125), ('2024-10-26', 66628.73, 126),
    ('2024-10-25', 68165.30, 127), ('2024-10-24', 66653.70, 128), ('2024-10-23', 67362.38, 129),
    ('2024-10-22', 67360.70, 130), ('2024-10-21', 69002.00, 131), ('2024-10-20', 68364.18, 132),
    ('2024-10-19', 68418.98, 133), ('2024-10-18', 67419.11, 134), ('2024-10-17', 67617.08, 135),
    ('2024-10-16', 67042.46, 136), ('2024-10-15', 66050.37, 137), ('2024-10-14', 62848.40, 138),
    ('2024-10-13', 63192.95, 139), ('2024-10-12', 62444.62, 140), ('2024-10-11', 60275.46, 141),
    ('2024-10-10', 60581.93, 142), ('2024-10-09', 62131.73, 143), ('2024-10-08', 62221.64, 144),
    ('2024-10-07', 62819.11, 145), ('2024-10-06', 62084.99, 146), ('2024-10-05', 62067.61, 147),
    ('2024-10-04', 60754.63, 148), ('2024-10-03', 60632.48, 149), ('2024-10-02', 60836.32, 150),
    ('2024-10-01', 63335.61, 151), ('2024-09-30', 65634.66, 152), ('2024-09-29', 65888.90, 153),
    ('2024-09-28', 65792.18, 154), ('2024-09-27', 65180.66, 155), ('2024-09-26', 63138.55, 156),
    ('2024-09-25', 64302.59, 157), ('2024-09-24', 63326.84, 158), ('2024-09-23', 63643.10, 159),
    ('2024-09-22', 63396.80, 160), ('2024-09-21', 63184.34, 161), ('2024-09-20', 62941.43, 162),
    ('2024-09-19', 61651.16, 163), ('2024-09-18', 60309.00, 164), ('2024-09-17', 58192.51, 165),
    ('2024-09-16', 59185.23, 166), ('2024-09-15', 60000.73, 167), ('2024-09-14', 60569.12, 168),
    ('2024-09-13', 58130.32, 169), ('2024-09-12', 57343.17, 170), ('2024-09-11', 57650.29, 171),
    ('2024-09-10', 57020.10, 172), ('2024-09-09', 54851.89, 173), ('2024-09-08', 54147.93, 174),
    ('2024-09-07', 53949.09, 175), ('2024-09-06', 56160.19, 176), ('2024-09-05', 57971.70, 177),
    ('2024-09-04', 57430.35, 178), ('2024-09-03', 59106.19, 179), ('2024-09-02', 57326.97, 180),
    ('2024-09-01', 58969.80, 181), ('2024-08-31', 59117.48, 182), ('2024-08-30', 59388.60, 183),
    ('2024-08-29', 59027.47, 184), ('2024-08-28', 59507.93, 185), ('2024-08-27', 62879.71, 186),
    ('2024-08-26', 64342.23, 187), ('2024-08-25', 64176.37, 188), ('2024-08-24', 64103.87, 189),
    ('2024-08-23', 60380.95, 190), ('2024-08-22', 61168.32, 191), ('2024-08-21', 59014.99, 192),
    ('2024-08-20', 59493.45, 193), ('2024-08-19', 58480.71, 194), ('2024-08-18', 59468.13, 195),
    ('2024-08-17', 58893.53, 196), ('2024-08-16', 57560.27, 197), ('2024-08-15', 58733.26, 198),
    ('2024-08-14', 60611.05, 199), ('2024-08-13', 59356.21, 200), ('2024-08-12', 58719.39, 201),
    ('2024-08-11', 60944.89, 202), ('2024-08-10', 60881.23, 203), ('2024-08-09', 61728.21, 204),
    ('2024-08-08', 55030.03, 205), ('2024-08-07', 56040.63, 206), ('2024-08-06', 53991.35, 207),
    ('2024-08-05', 58110.30, 208), ('2024-08-04', 60676.09, 209), ('2024-08-03', 61414.81, 210),
    ('2024-08-02', 65353.50, 211), ('2024-08-01', 64625.84, 212), ('2024-07-31', 66201.27, 213),
    ('2024-07-30', 66819.05, 214), ('2024-07-29', 68259.05, 215), ('2024-07-28', 67808.66, 216),
    ('2024-07-27', 67911.81, 217), ('2024-07-26', 65771.81, 218), ('2024-07-25', 65375.88, 219),
    ('2024-07-24', 65927.86, 220), ('2024-07-23', 67584.80, 221), ('2024-07-22', 68152.98, 222),
    ('2024-07-21', 67164.91, 223), ('2024-07-20', 66709.92, 224), ('2024-07-19', 63972.32, 225),
    ('2024-07-18', 64104.74, 226), ('2024-07-17', 65091.83, 227), ('2024-07-16', 64784.42, 228),
    ('2024-07-15', 60815.46, 229), ('2024-07-14', 59225.25, 230), ('2024-07-13', 57908.74, 231),
    ('2024-07-12', 57341.20, 232), ('2024-07-11', 57729.89, 233), ('2024-07-10', 58033.88, 234),
    ('2024-07-09', 56704.60, 235), ('2024-07-08', 55849.57, 236), ('2024-07-07', 58239.43, 237),
    ('2024-07-06', 56659.07, 238), ('2024-07-05', 57022.81, 239), ('2024-07-04', 60147.14, 240),
    ('2024-07-03', 62034.33, 241), ('2024-07-02', 62844.41, 242), ('2024-07-01', 62673.61, 243),
    ('2024-06-30', 60888.45, 244), ('2024-06-29', 60319.88, 245), ('2024-06-28', 61612.80, 246),
    ('2024-06-27', 60811.23, 247), ('2024-06-26', 61789.68, 248), ('2024-06-25', 60266.28, 249),
    ('2024-06-24', 63173.35, 250), ('2024-06-23', 64248.96, 251), ('2024-06-22', 64113.86, 252),
    ('2024-06-21', 64837.99, 253), ('2024-06-20', 64960.30, 254), ('2024-06-19', 65146.66, 255),
    ('2024-06-18', 66490.98, 256), ('2024-06-17', 66636.52, 257), ('2024-06-16', 66189.36, 258),
    ('2024-06-15', 66006.74, 259), ('2024-06-14', 66747.57, 260), ('2024-06-13', 68243.10, 261),
    ('2024-06-12', 67321.38, 262), ('2024-06-11', 69508.08, 263), ('2024-06-10', 69644.31, 264),
    ('2024-06-09', 69297.49, 265), ('2024-06-08', 69324.18, 266), ('2024-06-07', 70759.19, 267),
    ('2024-06-06', 71082.84, 268), ('2024-06-05', 70568.35, 269), ('2024-06-04', 68804.57, 270),
    ('2024-06-03', 67753.90, 271), ('2024-06-02', 67710.27, 272), ('2024-06-01', 67489.61, 273),
    ('2024-05-31', 68362.52, 274), ('2024-05-30', 67576.09, 275), ('2024-05-29', 68296.35, 276),
    ('2024-05-28', 69392.20, 277), ('2024-05-27', 68512.18, 278), ('2024-05-26', 69264.29, 279),
    ('2024-05-25', 68526.92, 280), ('2024-05-24', 67928.13, 281), ('2024-05-23', 69121.30, 282),
    ('2024-05-22', 70135.32, 283), ('2024-05-21', 71443.06, 284), ('2024-05-20', 66278.74, 285),
    ('2024-05-19', 66937.93, 286), ('2024-05-18', 67066.21, 287), ('2024-05-17', 65231.30, 288),
    ('2024-05-16', 66256.11, 289), ('2024-05-15', 61553.99, 290), ('2024-05-14', 62900.77, 291),
    ('2024-05-13', 61451.22, 292), ('2024-05-12', 60793.50, 293), ('2024-05-11', 60793.36, 294),
    ('2024-05-10', 63055.19, 295), ('2024-05-09', 61191.20, 296), ('2024-05-08', 62332.64, 297),
    ('2024-05-07', 63162.76, 298), ('2024-05-06', 64038.31, 299), ('2024-05-05', 63892.45, 300),
    ('2024-05-04', 62891.03, 301), ('2024-05-03', 59122.30, 302), ('2024-05-02', 58253.70, 303),
    ('2024-05-01', 60609.50, 304), ('2024-04-30', 63839.42, 305), ('2024-04-29', 63106.36, 306),
    ('2024-04-28', 63423.52, 307), ('2024-04-27', 63750.99, 308), ('2024-04-26', 64485.37, 309),
    ('2024-04-25', 64275.02, 310), ('2024-04-24', 66408.72, 311), ('2024-04-23', 66839.89, 312),
    ('2024-04-22', 64935.63, 313), ('2024-04-21', 64992.82, 314), ('2024-04-20', 63851.10, 315),
    ('2024-04-19', 63510.75, 316), ('2024-04-18', 61275.32, 317), ('2024-04-17', 63831.85, 318),
    ('2024-04-16', 63419.30, 319), ('2024-04-15', 65739.65, 320), ('2024-04-14', 63836.23, 321),
    ('2024-04-13', 67188.38, 322), ('2024-04-12', 70061.38, 323), ('2024-04-11', 70575.73, 324),
    ('2024-04-10', 69140.24, 325), ('2024-04-09', 71632.50, 326), ('2024-04-08', 69362.55, 327),
    ('2024-04-07', 68897.11, 328), ('2024-04-06', 67840.57, 329), ('2024-04-05', 68515.76, 330),
    ('2024-04-04', 65975.70, 331), ('2024-04-03', 65446.67, 332), ('2024-04-02', 69705.02, 333),
    ('2024-04-01', 71333.48, 334), ('2024-03-31', 69647.78, 335), ('2024-03-30', 69893.45, 336),
    ('2024-03-29', 70744.80, 337), ('2024-03-28', 69452.77, 338), ('2024-03-27', 69991.90, 339),
    ('2024-03-26', 69931.33, 340), ('2024-03-25', 67234.09, 341), ('2024-03-24', 64070.75, 342),
    ('2024-03-23', 63802.72, 343), ('2024-03-22', 65489.93, 344), ('2024-03-21', 67911.59, 345),
    ('2024-03-20', 61930.16, 346), ('2024-03-19', 67556.13, 347), ('2024-03-18', 68371.30, 348),
    ('2024-03-17', 65316.34, 349), ('2024-03-16', 69392.48, 350), ('2024-03-15', 71387.88, 351),
    ('2024-03-14', 73079.38, 352), ('2024-03-13', 71482.12, 353), ('2024-03-12', 72125.13, 354),
    ('2024-03-11', 69020.55, 355), ('2024-03-10', 68500.26, 356), ('2024-03-09', 68299.26, 357),
    ('2024-03-08', 66938.09, 358), ('2024-03-07', 66099.74, 359), ('2024-03-06', 63776.05, 360),
    ('2024-03-05', 68341.05, 361), ('2024-03-04', 63137.00, 362), ('2024-03-03', 62031.58, 363),
    ('2024-03-02', 62431.65, 364), ('2024-03-01', 61168.06, 365)
]

@st.cache_data
def create_bitcoin_analysis():
    df = pd.DataFrame(bitcoin_data, columns=['Date', 'Price', 'Day'])
    df['Date'] = pd.to_datetime(df['Date'])
    df = df.sort_values('Day', ascending=False).reset_index(drop=True)
    return df

def format_polynomial_equation(coefficients, degree):
    equation = "y = "
    terms = []
    for i, coef in enumerate(coefficients):
        power = degree - i
        if abs(coef) < 1e-10:
            continue
        if i == 0:
            coef_str = f"{coef:.6e}" if abs(coef) < 0.001 or abs(coef) > 1000 else f"{coef:.6f}"
        else:
            sign = "+" if coef >= 0 else "-"
            coef_abs = abs(coef)
            coef_str = f" {sign} {coef_abs:.6e}" if coef_abs < 0.001 or coef_abs > 1000 else f" {sign} {coef_abs:.6f}"
        
        if power == 0:
            term = coef_str
        elif power == 1:
            term = f"{coef_str}x"
        else:
            term = f"{coef_str}x^{power}"
        terms.append(term)
    return equation + "".join(terms)

def plot_regression(df, degree):
    X = df['Day'].values.reshape(-1, 1)
    y = df['Price'].values

    poly = PolynomialFeatures(degree=degree)
    X_poly = poly.fit_transform(X)
    model = LinearRegression().fit(X_poly, y)
    y_pred = model.predict(X_poly)
    r2 = r2_score(y, y_pred)

    coeffs = np.append(model.coef_[1:], model.intercept_)
    equation = format_polynomial_equation(coeffs, degree)

    fig, ax = plt.subplots(figsize=(10, 6))
    ax.scatter(df['Day'], df['Price'], label='Actual Data', alpha=0.6)
    ax.plot(df['Day'], y_pred, label=f'Degree {degree} fit (R²={r2:.4f})', linewidth=2)
    ax.set_xlabel('Days (from March 2024)')
    ax.set_ylabel('Bitcoin Price ($)')
    ax.set_title('Bitcoin Price Polynomial Regression')
    ax.invert_xaxis()
    ax.grid(True, alpha=0.3)
    ax.legend()
    return fig, r2, equation

def main():
    st.title('Bitcoin Price Polynomial Regression')
    
    # Load data
    df = create_bitcoin_analysis()

    # Select degree
    degree = st.sidebar.slider('Polynomial Degree', min_value=1, max_value=10, value=2)

    # Plot and display
    fig, r2, equation = plot_regression(df, degree)
    st.pyplot(fig)
    st.write(f'**R² Score:** {r2:.6f}')
    st.write(f'**Polynomial Equation:** {equation}')

if __name__ == '__main__':
    main()